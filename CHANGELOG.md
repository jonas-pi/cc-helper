# CC 命令助手 - 更新日志

## v0.3.4 (2026-01-07) - 参数传递修复与环境自动配置

### 🎯 核心问题修复

- **修复 PowerShell 参数传递问题**
  - 问题原因：直接调用 `cc.ps1` 时，中文参数会被 PowerShell 错误解析为 `System.Object[]`，导致模型收到空提示
  - 解决方案：添加 `-setup` 命令，自动配置包装函数到 PowerShell Profile
  - 包装函数使用 `ValueFromRemainingArguments` 参数，正确处理所有参数类型
  - 效果：配置后可直接使用 `cc 你好` 而无需引号，参数正确传递

### ✨ 新功能

- **新增 `cc -setup` 命令**
  - 自动创建 PowerShell Profile（如果不存在）
  - 自动配置 UTF-8 编码（解决中文显示问题）
  - 自动添加 CC 包装函数（修复参数传递）
  - 自动应用到当前会话
  - 一键完成所有环境配置，无需手动操作

### 🔧 技术改进

- **移除调试输出**
  - 清理临时调试代码，保持代码整洁
  - 问题已解决，不再需要调试信息

- **改进帮助信息**
  - 在帮助菜单中添加 `cc -setup` 命令说明

### 📝 使用说明

首次使用或遇到参数传递问题时，运行：
```powershell
cc -setup
```

配置完成后，即可直接使用：
```powershell
cc 你好
cc 列出当前目录
cc -r
```

## v0.3.3 (2026-01-07) - 关键 Bug 修复与功能改进

### 🐛 关键 Bug 修复

- **修复配置文件加载失败问题**
  - 问题原因：直接使用 `.` 加载配置文件在编码不匹配时会失败，导致 MODE 等配置丢失
  - 解决方案：使用正则表达式提取配置项，支持 UTF-8 编码读取
  - 改进 CONFIGURED_MODELS 数组解析，支持多种格式
  - 效果：配置文件加载更稳定，不再出现"配置文件加载失败"警告

- **修复工作模式提示词问题**
  - 问题原因：工作模式下模型返回了 PowerShell 数组初始化代码，说明提示词没有正确引导
  - 解决方案：重新添加 NOT_A_COMMAND 判断逻辑，明确区分命令需求和非命令需求
  - 优化 CMD 和 PowerShell 的提示词，确保模型理解意图
  - 效果：工作模式下能正确生成命令，非命令输入会提示切换到休息模式

- **修复编码问题导致的中文提示词损坏**
  - 确保配置文件以 UTF-8 编码读取
  - 改进错误处理，提供更清晰的错误信息

### ✨ 功能改进

- **改进 `cc -change` 命令**
  - 同时显示已配置的 API 模型和本地已下载的 Ollama 模型
  - 选择本地模型时自动切换到 Ollama API
  - 去重显示，避免重复列出相同模型

- **优化 Token 使用**
  - 休息模式：256 tokens（支持更长回复）
  - 工作模式：64 tokens（命令通常较短）

- **改进已配置模型列表持久化**
  - 使用正则表达式解析配置文件，更健壮
  - 支持数组和字符串两种格式（向后兼容）

### 🔧 技术改进

- **配置文件加载机制重构**
  - 使用正则表达式提取配置项，替代直接 `.` 加载
  - 支持 UTF-8 编码读取，避免编码问题
  - 更详细的错误提示，引导用户重新配置

- **提示词优化**
  - 工作模式：明确区分命令需求和非命令需求
  - 休息模式：保持友好的聊天风格
  - 系统消息和用户提示词分离，更清晰

## v0.3.2 (2026-01-07) - GBK 编码输出修复

### 🐛 关键 Bug 修复

- **修复 GBK 环境下 API 响应乱码问题（核心修复）**
  - 问题原因：`Invoke-RestMethod` 在 GBK 环境下使用控制台编码解析 UTF-8 响应，导致中文显示为 `????????????????`
  - 解决方案：使用 `Invoke-WebRequest` 并显式处理 UTF-8 编码
    * 将 JSON body 转换为 UTF-8 字节数组发送
    * 显式指定 `ContentType: "application/json; charset=utf-8"`
    * 手动解析 UTF-8 响应：`UTF8.GetString(webResponse.Content)`
  - 修复范围：`Get-AICommand` 函数和 `testapi` 命令
  - 效果：无论控制台编码是 GBK 还是 UTF-8，都能正确显示 API 返回的中文内容

- **修复 GBK 编码环境下的输出乱码问题**
  - 创建 Safe-Write-Host 函数，智能处理 GBK 编码输出
  - 在 GBK 环境下检测特殊字符，自动切换到 UTF-8 输出
  - 添加编码提示，引导用户切换到 UTF-8 获得最佳显示效果

### 🔧 技术改进

- **改进变量作用域管理**
  - 使用脚本作用域变量（`$script:`）确保所有函数正确访问配置
  - 配置文件加载后同步到脚本作用域
  - 向后兼容：同时设置局部变量

- **改进错误处理**
  - 更好的编码转换错误处理
  - 更清晰的错误提示信息

## v0.3.1 (2026-01-07) - 安装与编码修复

### 🐛 Bug 修复

- **修复安装脚本模型配置问题**
  - 修复安装脚本根据实际安装的模型设置默认模型
  - 云端模式不再设置默认模型，提示用户使用 `cc -config` 配置
  - 修复模型拉取后自动检测并使用已安装的模型

- **修复预设命令模型检查问题**
  - 所有预设命令（除 testapi 外）不再需要模型检查
  - testapi 命令在内部添加模型检查，确保测试前模型可用
  - 修复变量作用域问题，确保所有函数正确访问配置变量

- **修复 PowerShell 错误重定向语法**
  - 修复 `uninstall.ps1` 中的 `2>$null` 语法错误
  - 改为使用 `2>&1 | Out-Null` 正确重定向错误输出
  - 添加 try-catch 错误处理，提升错误报告

- **修复 GBK 编码环境下的输出乱码**
  - 修复命令输出时的编码问题
  - 在 GBK 环境下临时切换到 UTF-8 输出命令，避免问号乱码
  - 移除错误的 Unicode 到 GBK 转换逻辑

### ✨ 新功能

- **增强 `cc -fix` 命令**
  - 全面检测：编码、模型、API 连接
  - 自动修复：模型不存在时自动切换到可用模型
  - 简洁提示：使用 `[1/3]`、`[2/3]`、`[3/3]` 格式
  - 提供修复选项：编码切换、API 测试、API 配置

### 🔧 改进

- **改进安装脚本**
  - 从 GitHub 下载最新版本的 `cc.ps1` 而不是使用硬编码模板
  - 自动替换默认模型为用户选择的模型
  - 创建配置文件时使用正确的模型设置

- **改进变量作用域管理**
  - 所有配置变量使用 `$script:` 作用域
  - 确保配置文件加载后正确同步到脚本作用域
  - 修复 API 调用时使用错误的变量作用域问题

## v0.3.0 (2026-01-07) - Tab 补全与功能增强

### ✨ 重大新功能

- **Tab 补全支持**（`cc -<Tab>` 查看所有命令）
  - 新增 `cc-completion.bash` for Linux/Bash
  - 新增 `cc-completion.ps1` for Windows/PowerShell
  - 支持所有预设命令的智能补全
  - 安装脚本自动配置补全功能
  - `cc -u` 更新时自动更新补全脚本

- **增强 cc -change 命令**
  - Ollama: 列出本地已下载的模型供切换
  - 云端 API: 列出常见模型 + 支持手动输入
    * OpenAI: gpt-3.5-turbo, gpt-4, gpt-4o 等
    * Anthropic: claude-3-haiku, claude-3-sonnet 等
    * DeepSeek: deepseek-chat, deepseek-coder
    * 通义千问: qwen-plus, qwen-turbo, qwen-max
    * 豆包: doubao-pro-32k, doubao-lite-32k
  - 切换后提示使用 `cc testapi` 测试新模型

### 🐛 关键 Bug 修复

- **修复 Windows GBK 环境下的乱码问题**
  - 问题原因：在 GBK 环境下更新时，主脚本被保存为 GBK 编码，导致中文字符显示为 `????????????????`
  - 解决方案：主脚本始终使用 UTF-8 with BOM 保存，PowerShell 能正确识别
  - 配置文件继续根据环境编码保存（兼容性）

- **修复更新日志解析问题**
  - Linux: 增加读取行数，使用 awk 正确提取版本更新内容
  - Windows: 移除行数限制，显示完整的版本更新内容

### 🎭 性格设定

- **将 cc 的性格特点写入休息模式提示词**
  - 性格：表面高冷实际上内心可爱热情的女孩子
  - 工作时专注高效（工作模式）
  - 休息时可爱热情（休息模式）
  - 回复保持简洁、友好，偶尔展现可爱的一面

### 🔧 改进

- **cc -u 更新命令增强**
  - 自动更新 Tab 补全脚本
  - 自动检查并添加补全配置到 .bashrc 或 Profile
  - 更好的错误处理和提示信息

- **配置文件更新逻辑优化**
  - 更健壮的正则表达式匹配
  - 如果找不到设置，自动添加到配置文件末尾
  - 立即更新当前会话的变量

### 📝 文档

- README 添加 Tab 补全特性说明
- 提示用户可以使用 `cc -<Tab>` 查看所有命令

---

## v0.2.3 (2026-01-07) - 修复 PowerShell 流式传输 Bug

### 🐛 关键 Bug 修复
- **修复 PowerShell 开启流式传输后导致的 "ERROR: 模型无响应" 问题**
  - 问题原因：用户运行 `cc -stream` 后，PowerShell 在 API 请求中设置了 `stream: true`，但没有实现流式响应（SSE）的解析逻辑
  - 症状：开启流式传输后，所有 API 调用都返回 "ERROR: 模型无响应"
  - 解决方案：
    * 暂时禁用 PowerShell 的流式传输功能（强制 `stream = false`）
    * `Invoke-RestMethod` 无法正确解析 Server-Sent Events (SSE) 流式响应
    * 未来版本将实现完整的流式传输支持

- **调整 NOT_A_COMMAND 检查顺序**
  - 将非命令检查移到 `Sanitize-Command` 之前
  - 避免清理函数影响 `NOT_A_COMMAND` 标记的识别

### ✨ 改进
- **改进工作模式提示词**
  - 更明确地要求模型判断输入是否为命令需求
  - 提供具体示例（"你好"、"谢谢"等是非命令输入）
  - 强调非命令输入只输出 `NOT_A_COMMAND`，不要其他内容

### 📝 说明
- PowerShell 版本的流式传输功能正在开发中
- 当前版本 `cc -stream` 命令在 PowerShell 上不会生效
- Linux/Bash 版本的流式传输功能正常工作

---

## v0.2.2 (2026-01-07) - 修复模式切换和命令识别

### 🐛 关键 Bug 修复
- **修复休息模式下配置文件更新逻辑不健壮的问题**
  - 问题原因：正则表达式 `'^\$MODE = ".*"'` 只匹配行首，如果配置文件中有注释、空格或格式不同，可能无法匹配
  - 解决方案：
    * 使用多行模式正则 `(?m)^\s*\$MODE\s*=\s*".*"`，能匹配各种格式的 MODE 设置
    * 如果找不到 MODE 设置，自动添加到配置文件末尾
    * 更新配置文件后，立即更新当前会话的 `$MODE` 变量
  - 现在 `cc -r` 切换到休息模式后，可以正常聊天了

- **修复工作模式下将非命令输入（如"你好"）误转换为命令的问题**
  - 问题原因：工作模式的提示词没有区分命令需求和非命令输入
  - 解决方案：
    * 改进提示词，明确告知模型：如果输入不是命令需求（如问候语、闲聊），应返回 `"NOT_A_COMMAND"`
    * 在工作模式处理逻辑中检查返回内容，如果是非命令输入，显示友好提示
  - 现在在工作模式下输入"你好"等非命令内容时，会提示："别闹，好好工作。"并建议使用 `cc -r` 切换到休息模式

### ✨ 改进
- **改进配置文件加载逻辑**
  - 添加错误处理，加载失败时使用默认值
  - 确保 MODE 变量始终有有效值

### 🎯 使用示例
```powershell
# 工作模式下输入非命令
cc 你好
# 输出：别闹，好好工作。想聊天？用 cc -r 切换到休息模式~

# 切换到休息模式
cc -r
cc 你好
# 输出：AI 的友好回复（正常聊天）
```

---

## v0.2.1 (2026-01-07) - 修复流式传输 Bug

### 🐛 关键 Bug 修复
- **修复流式传输 "ERROR: 模型无响应" 问题**
  - 问题原因：Bash 管道 (`|`) 创建子 shell，导致 `full_response` 变量无法传递到父 shell
  - 症状：流式内容正常显示，但最后报错 "ERROR: 模型无响应"
  - 解决方案：
    * 使用临时文件存储流式响应
    * 使用进程替换 `< <(cmd)` 代替管道 `| while`
    * 从临时文件读取完整响应
    * 自动清理临时文件

### 🔧 技术细节
**修复前（有 Bug）：**
```bash
eval $curl_cmd | while read -r line; do
    full_response+="$content"  # 在子 shell 中，无法传递到父 shell
done
echo "$full_response"  # 仍然为空 → ERROR
```

**修复后：**
```bash
temp_file=$(mktemp)
while read -r line; do
    echo -n "$content" >> "$temp_file"  # 写入临时文件
done < <(eval $curl_cmd)  # 进程替换，避免子 shell
full_response=$(cat "$temp_file")  # 从文件读取
rm -f "$temp_file"  # 清理
echo "$full_response"  # ✓ 正确返回
```

### ✅ 测试结果
```bash
cc -stream        # 开启流式传输
cc -r             # 休息模式
cc 你好           # ✓ 逐字显示 + 正常返回，无错误
```

---

## v0.2.0 (2026-01-07) - 流式传输支持

### ✨ 重大新功能：流式传输
- **新增 `cc -stream` 命令**：切换流式传输模式
  - 开启后，AI 响应将逐字显示（打字机效果）
  - 关闭后，响应一次性显示（默认）
  - 配置持久化到 `~/.cc_config` 或 `.cc_config.ps1`

### 🎯 使用方式
```bash
# 开启流式传输
cc -stream  # 切换状态

# 切换到休息模式并聊天
cc -r
cc 讲一个故事  # 看到逐字显示效果（Linux 完整支持）

# 查看当前配置
cc hello  # 显示流式传输状态
```

### 📋 功能说明
- **Linux/macOS (Bash)**：✅ 完整支持流式传输
  - 使用 `curl -N --no-buffer` 实时接收 SSE 流
  - 逐行解析 `data:` 格式
  - 实时逐字显示响应内容
- **Windows (PowerShell)**：⚠️ 部分支持
  - 已添加 `cc -stream` 命令和配置
  - API 请求中已启用 `stream: true`
  - 显示逻辑暂为一次性输出（流式解析功能开发中）

### ⚙️ 技术细节
- 流式传输仅在**休息模式** (`cc -r`) 下生效
- 工作模式需要完整命令，不支持流式传输
- 使用 Server-Sent Events (SSE) 协议
- 灰色显示流式内容，最终返回完整文本

### 🔧 配置示例
**Linux `~/.cc_config`:**
```bash
STREAM="true"  # 开启流式传输
MODE="rest"    # 休息模式
```

**Windows `%USERPROFILE%\.cc_config.ps1`:**
```powershell
$STREAM = $true  # 开启流式传输
$MODE = "rest"   # 休息模式
```

---

## v0.1.5 (2026-01-07) - 增强 fix 功能

### ✨ 新增功能
- **`cc -fix` 新增强制更新选项**
  - 编码检测完成后，询问用户是否立即强制更新
  - 一键完成编码修复 + 版本更新
  - 自动备份当前版本
  - 确保编码修复后使用最新版本

### 使用场景
```bash
# Linux
cc -fix
# 1. 检测编码
# 2. 显示字符测试
# 3. 询问是否强制更新 [y/n]

# Windows
cc -fix
# 1. 检测编码
# 2. 可选切换编码 [1/2/n]
# 3. 询问是否强制更新 [y/n]
```

### 优势
- 修复编码问题后无需手动运行 `cc -u`
- 确保编码和版本同步更新
- 减少用户操作步骤

---

## v0.1.4 (2026-01-07) - 安全性与编码修复

### 🔒 安全性改进
- **更新 .gitignore**：确保用户配置文件（包含 API Key）不会被提交到 git
  - 添加 `.cc_config` (Linux)
  - 添加 `.cc_config.ps1` (Windows)
  - 防止 API Key 泄露

### ✨ 新增功能
- **新增 `cc -fix` 命令**：编码检测和修复工具
  - Linux: 检测 LANG 和 locale 编码，提供 UTF-8 配置建议
  - Windows: 检测 CodePage，提供 UTF-8/GBK 切换选项
  - 交互式编码切换和测试
  - 显示当前使用的字符集（表情、列表符号等）

### ⚡ 性能优化
- **curl 请求优化**：添加 `--compressed` 标志启用 gzip 压缩
  - 减少数据传输量
  - 加快 API 响应速度（如果服务器支持压缩）

### 📝 文档更新
- README 添加 `cc -fix` 命令说明
- 帮助信息 (`cc -h`) 添加 `cc -fix` 命令

---

## v0.1.3 (2026-01-07) - 修复模式切换

### 🐛 关键 Bug 修复
- **修复 `cc -w` 和 `cc -r` 模式切换不生效的问题**
  - 问题原因：脚本修改的是 `cc.sh`/`cc.ps1` 文件本身，但 `MODE` 配置实际从 `~/.cc_config` 加载
  - 解决方案：改为修改配置文件 `~/.cc_config` (Linux) 或 `%USERPROFILE%\.cc_config.ps1` (Windows)
  - 现在 `cc -r` 切换到休息模式后，可以正常聊天了
  - 现在 `cc -w` 切换回工作模式后，只输出命令

### 测试结果
```bash
# Linux
cc -r           # 切换到休息模式
cc 你好          # 返回聊天回复（而不是命令）
cc -w           # 切换回工作模式
cc 你好          # 返回 echo "你好" 命令
```

---

## v0.1.2 (2026-01-07) - 稳定性修复

### 🐛 关键 Bug 修复

**Linux (Bash):**
- **修复 DeepSeek/豆包/通义千问 等云端 API 无法连接的问题**
  - 问题原因：`curl` 命令中 `$auth_header` 变量无法正确展开带引号的 header
  - 解决方案：直接在 `curl` 命令中使用 `-H "Authorization: Bearer $API_KEY"`
  - 影响范围：`cc testapi` 和 `cc <命令>` 的 API 调用
- **修复 HTTP 状态码 000 错误**：现在可以正确发送 Authorization header
- **符合 DeepSeek API 官方文档标准**：[https://api-docs.deepseek.com/zh-cn/](https://api-docs.deepseek.com/zh-cn/)

**Windows (PowerShell):**
- **修复 `[System.Object[]]` 返回问题**
  - 问题原因：API 返回的 `content` 可能是数组类型
  - 解决方案：增强类型检查，单元素数组取第一个元素，多元素数组用换行符连接
  - 确保返回值强制转换为 `[string]` 类型
- **提升稳定性**：更可靠的字符串类型转换逻辑

### 版本说明
- 版本号调整为 0.1.x，反映项目处于早期阶段
- 专注于修复核心功能，确保基本可用性

---

## v0.9.0 (2026-01-07) - 已废弃

### 重大变化
- 🔄 版本号降级为测试版 (0.9.0)，以反映当前的稳定性状态

### 新增功能
- ✨ **新增 `cc testapi` 命令**：诊断 API 连接问题，提供详细的错误诊断和解决建议
- ✨ **简化 `cc help` 输出**：只列出命令清单，不再显示冗长的描述和示例

### Bug 修复
- 🐛 **修复 PowerShell 变量作用域问题**：Check-And-Select-Model 现在使用 `$script:` 前缀访问全局变量
- 🐛 **修复命令返回 [System.Object[]] 的问题**：改进参数处理和返回值类型检查
- 🐛 **修复云端 API 模型检查**：使用云端 API 时不再错误检查 Ollama 本地模型

### 已知问题
- ⚠️ Windows 用户在更新后，如果仍然看到 "注意: 使用模型 xxx" 错误，请尝试：
  1. 删除旧的 cc.ps1：`Remove-Item $env:USERPROFILE\cc.ps1`
  2. 重新下载：`irm https://raw.githubusercontent.com/jonas-pi/cc-helper/main/install.ps1 | iex`
  3. 重新配置 API：`cc -config`

